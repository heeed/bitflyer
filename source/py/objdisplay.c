#include <string.h>
#include <assert.h>
#include <stdint.h>

#include "py/nlr.h"
#include "py/runtime0.h"
#include "py/runtime.h"
#include "py/binary.h"


static unsigned char display_buf_dirty = 0b11111111;

#define DISP_BUF_LEN 128*8
unsigned char display_buf[DISP_BUF_LEN] = {0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xdd,0x3,0xdf,0xff,0xdf,0xef,0xc1,0xdf,0xff,0xc1,0xdd,0xdd,0xdd,0xe3,0xff,0xdd,0x3,0xdf,0xff,0xdb,0xd5,0xd5,0xd5,0xed,0xff,0xff,0xff,0xff,0xe3,0xdd,0xdd,0xdd,0xe3,0xff,0xdd,0x3,0xdf,0xff,0xff,0xff,0xff,0xe1,0xdf,0xdf,0xdf,0xe1,0xdf,0xff,0xe3,0xdd,0xdd,0xdd,0xe3,0xff,0xdd,0x3,0xdf,0xff,0xdd,0x3,0xdf,0xff,0xc3,0xfd,0xfd,0xfd,0xc3,0xdf,0xff,0xe3,0xdd,0xdd,0xdd,0x1,0xff,0xff,0xff,0xff,0xff,0xdb,0xd5,0xd5,0xd5,0xed,0xff,0xdb,0xd5,0xd5,0xd5,0xed,0xff,0xe5,0xd5,0xd5,0xd5,0xe3,0xff,0xdf,0xef,0xc1,0xdf,0xff,0x9f,0x6f,0x6f,0x6f,0x1,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0xc7,0x67,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0xc7,0x67,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x87,0xc7,0xc7,0xc7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x67,0xc7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x4,0x5,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x0,0x0,0x0,0x30,0x6c,0x86,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xc0,0x70,0xe,0x1,0x0,0x0,0x0,0x0,0xf0,0x78,0x1e,0xb,0x8d,0x46,0x63,0x21,0x20,0x30,0xe0,0xc0,0x0,0x0,0x0,0x0,0x0,0x1,0x86,0x6c,0x30,0x0,0x0,0x0,0x0,0x0,0x1,0x0,0x0,0x0,0x40,0x0,0x0,0x2,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x20,0x0,0x0,0x0,0x10,0x0,0x0,0x0,0x0,0x0,0x0,0x80,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x10,0x0,0x0,0x0,0x0,0x40,0x0,0x2,0x0,0x0,0x0,0x0,0x0,0x0,0x8,0x0,0x80,0x0,0x8,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x4,0x0,0x0,0x0,0x40,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x3,0x6,0x18,0x0,0x0,0x0,0x0,0x0,0x10,0xe,0x1,0x40,0x0,0x0,0x0,0x0,0x0,0x0,0xf,0x18,0x10,0x11,0x10,0x10,0x8,0xc,0x6,0x3,0x1,0x0,0x0,0x0,0x0,0x98,0x6,0x3,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x20,0x2,0x0,0x0,0x0,0x20,0x0,0x0,0x0,0x0,0x0,0x1,0x0,0x0,0x0,0x0,0x80,0xc0,0x60,0x60,0x60,0x60,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x20,0x0,0x0,0x0,0x0,0x0,0xc0,0x40,0x60,0x60,0xe0,0xe0,0x40,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x8,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x4,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x80,0x0,0x0,0x0,0x4,0x0,0x0,0x0,0x0,0x0,0x80,0x0,0x0,0x0,0x0,0x40,0x0,0x0,0x0,0x0,0x10,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x80,0xe0,0xe1,0x60,0x0,0x0,0x80,0xc0,0x60,0x70,0x70,0xf0,0xe0,0xc0,0x0,0x0,0x0,0x0,0xc0,0xf0,0xf8,0xfe,0x7,0x1,0x0,0x0,0x0,0x0,0x80,0xc0,0x60,0xf2,0xf0,0xf0,0x0,0x0,0x0,0x0,0x0,0xf0,0xfe,0x7f,0x7,0x0,0x0,0x80,0xc0,0x60,0x20,0xf0,0xf0,0xf0,0x0,0x0,0x80,0xc0,0x60,0xe0,0xf0,0xf0,0x0,0x0,0x0,0x80,0xc0,0xc0,0xe0,0x60,0x20,0x30,0x30,0x20,0x20,0xe0,0xe0,0xe0,0xe0,0x20,0x20,0x21,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x40,0x0,0x0,0x0,0x0,0x0,0x10,0x0,0x0,0x0,0x0,0x0,0x8,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x0,0x0,0x80,0xc0,0x80,0x80,0xc0,0x60,0xf8,0xfe,0xff,0x9f,0xc3,0x0,0x80,0xe0,0xf1,0x18,0x88,0x8c,0xec,0x7f,0x1f,0x7,0x0,0xe0,0xfc,0xf,0x1,0x1f,0xff,0xff,0xf0,0x80,0xc0,0x60,0x0,0x0,0xc1,0xf8,0xfe,0x3f,0x7,0x81,0x80,0x80,0x80,0xf0,0xff,0xff,0x8f,0x80,0x80,0x0,0x0,0x1,0xc0,0xf0,0xfe,0x3f,0x7,0x0,0x0,0x80,0xe1,0xf8,0xfe,0x9f,0x47,0x21,0x0,0x0,0x1e,0x3f,0x7f,0xff,0xc0,0x80,0x80,0x80,0x80,0xc0,0xfc,0xff,0xff,0x7,0x0,0x0,0x0,0x0,0x0,0x0,0x10,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xc8,0xf0,0x70,0x38,0x98,0x98,0x18,0x18,0x18,0x18,0x98,0x98,0x38,0x70,0xf0,0xc0,0x2,0x0,0x0,0x0,0x0,0x0,0x0,0x40,0x0,0x0,0x0,0x10,0x0,0x0,0x1,0x3,0x3,0x1,0x0,0x0,0x3,0x3,0x1,0x1,0x0,0x0,0x0,0x1,0x3,0x3,0x41,0x1,0x0,0x0,0x0,0x0,0x41,0x3,0x0,0x0,0x0,0x0,0x0,0x1,0x3,0x3,0x1,0xc0,0xf8,0xff,0xbf,0x87,0x80,0x0,0x0,0x1,0x81,0xe1,0x7f,0x3f,0xf,0x1,0x1,0x1,0x41,0x1,0x1,0x1f,0x1f,0xf,0x3,0x1,0x1,0x0,0xc0,0xe1,0xc3,0x3,0x1,0x0,0x0,0x0,0x0,0x38,0xfc,0xfe,0xff,0x83,0x1,0x0,0x0,0xc0,0xfc,0xff,0xff,0x8f,0x0,0x0,0x0,0x0,0x20,0x0,0x0,0x0,0x0,0x80,0x0,0x0,0x0,0x0,0x0,0x0,0x3,0x1f,0xc,0x1c,0x19,0x1b,0x18,0x18,0x18,0x18,0x19,0x19,0x1c,0xe,0xf,0x3,0x0,0x4,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x8,0x0,0x0,0x0,0x0,0x4,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x2,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x80,0x0,0x0,0x1,0x0,0x0,0x0,0x0,0x0,0x3,0x3,0x1,0x1,0x1,0x3,0x3,0x3,0x3,0x3,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x8,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x1,0x0,0x0,0x0,0x0,0x10,0x0,0x0,0x0,0x0,0x0,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0};


unsigned char go_bottom[] = {0x1c,0xbe,0xfc,0xf0,0xf0,0xe0,0xfc,0xfe,0xfe,0xfe,0xfe,0xfc,0x0,0x0,0x8c,0xde,0xde,0xde,0xde,0xde,0xfe,0xfe,0xfe,0xfe,0xfe,0xfc,0x0,0x0,0xc0,0xe0,0xf0,0x7c,0x7c,0x3e,0xfe,0xfe,0xfe,0xfe,0xfc,0xf8,0x0,0x0,0xf8,0xfc,0xfe,0xfe,0x1e,0x1e,0x1e,0xfe,0xfe,0xfe,0xfe,0xfe,0xfc,0xf8,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x8c,0xde,0xde,0xde,0xde,0xde,0xfe,0xfe,0xfe,0xfe,0xfe,0xfc,0x0,0x0,0xfc,0xfe,0xfc,0xfc,0xc0,0xe0,0xc0,0xfc,0xfc,0xfe,0xfe,0xfe,0xfc,0x0,0x0,0xfc,0xfe,0xfc,0xc0,0xc0,0xc0,0xfc,0xfe,0xfe,0xfe,0xfe,0xfc,0x0,0x0,0xf8,0xfc,0xfe,0xfe,0x1e,0x1e,0x1e,0xfe,0xfe,0xfe,0xfe,0xfe,0xfc,0xf8};
unsigned char go_top[] = {0x7,0xf,0x1f,0x1d,0x1d,0x1d,0x1f,0x1f,0x17,0x17,0x13,0xf,0x0,0x0,0x8,0x1d,0x1d,0x1d,0x1d,0x1d,0x1f,0x1f,0x17,0x17,0x13,0xf,0x0,0x0,0xf,0x1f,0xf,0x0,0x0,0x0,0xf,0x1f,0x17,0x17,0x11,0xf,0x0,0x0,0x1f,0x3f,0x7f,0x7f,0x70,0x70,0x70,0x7f,0x7f,0x7f,0x7f,0x5f,0xf,0x1f,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x8,0x1d,0x1d,0x1d,0x1d,0x1d,0x1f,0x1f,0x17,0x17,0x13,0xf,0x0,0x0,0xf,0x1f,0xf,0xf,0x1,0x1,0x1,0xf,0xf,0x17,0x17,0x11,0xf,0x0,0x0,0x7,0xf,0x1f,0x1d,0x1d,0x1d,0x1f,0x1f,0x1f,0x17,0x3,0x7,0x0,0x0,0x21,0x71,0x71,0x71,0x71,0x71,0x70,0x7f,0x7f,0x7f,0x7f,0x5f,0xf,0x1f};
static void mb_i2c_write(mp_int_t addr, const char *data, mp_int_t len, char prefix);


mp_int_t display_get_buffer(mp_obj_t self_in, mp_buffer_info_t *bufinfo, mp_uint_t flags) {
    bufinfo->buf = (void*)display_buf;
    bufinfo->len = DISP_BUF_LEN;
    bufinfo->typecode = 'b';
    return 0;
}

STATIC mp_obj_t display_binary_op(mp_uint_t op, mp_obj_t lhs_in, mp_obj_t rhs_in) {return MP_OBJ_NULL;}
STATIC mp_obj_t display_unary_op(mp_uint_t op, mp_obj_t o_in) {
    switch (op) {
        case MP_UNARY_OP_LEN: return MP_OBJ_NEW_SMALL_INT(DISP_BUF_LEN);
        default: return MP_OBJ_NULL; // op not supported
    }
}

void _mark_dirty(mp_int_t row){
    display_buf_dirty |= 1 << row;
}

unsigned char _first_dirty_row(){
    return __builtin_ffs(display_buf_dirty) - 1;
}

static const int CLZ_OFFSET = sizeof(unsigned int) * 8 - 1;
unsigned char _last_dirty_row(){
    return CLZ_OFFSET - __builtin_clz(display_buf_dirty);
}

STATIC mp_obj_t display_mark_dirty(mp_obj_t self_in, mp_obj_t arg) {
    mp_int_t row = MP_OBJ_SMALL_INT_VALUE(arg);
    _mark_dirty(row);
    return mp_const_none;
}
STATIC MP_DEFINE_CONST_FUN_OBJ_2(display_mark_dirty_obj, display_mark_dirty);

STATIC mp_obj_t display_subscr(mp_obj_t self_in, mp_obj_t index_in, mp_obj_t value) {
    if (value == MP_OBJ_NULL) {
        // delete item
        return MP_OBJ_NULL; // op not supported
    } else {
        mp_uint_t index = mp_get_index(&mp_type_display, DISP_BUF_LEN, index_in, false);
        if (value == MP_OBJ_SENTINEL) {
            // load
            return MP_OBJ_NEW_SMALL_INT(display_buf[index]);
        } else {
            // store
            mp_int_t val = MP_OBJ_SMALL_INT_VALUE(value);
            _mark_dirty(index/128);
            display_buf[index] = (unsigned char)val;
            return mp_const_none;
        }
    }
}

STATIC mp_obj_t display_repaint(mp_obj_t _, mp_obj_t arg) {
    mp_int_t addr = MP_OBJ_SMALL_INT_VALUE(arg);
    if (display_buf_dirty == 0) {
        return mp_const_none;
    }
    char start_row = _first_dirty_row();
    char stop_row = _last_dirty_row();

    char cmd_buf[2] = {0x22, 0};
    mb_i2c_write(arg, cmd_buf, 1, 128);
    cmd_buf[0] = start_row;
    mb_i2c_write(arg, cmd_buf, 1, 128);
    cmd_buf[0] = 7;
    mb_i2c_write(arg, cmd_buf, 1, 128);
    mb_i2c_write(arg, &(((char unsigned *)display_buf)[start_row*128]), (1+ stop_row - start_row) * 128, 64);
    display_buf_dirty = 0;
    return mp_const_none;
}
STATIC MP_DEFINE_CONST_FUN_OBJ_2(display_repaint_obj, display_repaint);


STATIC mp_obj_t display_blit(mp_uint_t n_args, const mp_obj_t *pos_args, mp_map_t *kw_args) {
    static const mp_arg_t allowed_args[] = {
        { MP_QSTR_data,  MP_ARG_OBJ, {.u_obj = MP_OBJ_NULL} },
        { MP_QSTR_x,     MP_ARG_INT, {.u_int = 0} },
        { MP_QSTR_y,     MP_ARG_INT, {.u_int = 0} },
        { MP_QSTR_unset, MP_ARG_INT, {.u_int = 0} },
        { MP_QSTR_builtin, MP_ARG_INT, {.u_int = -1} },
    };
    // parse args
    mp_arg_val_t args[MP_ARRAY_SIZE(allowed_args)];
    mp_arg_parse_all(n_args - 1, pos_args + 1, kw_args, MP_ARRAY_SIZE(allowed_args), allowed_args, args);

    mp_buffer_info_t buf_info;
    const char *data;

    if (args[4].u_int < 0) {
        mp_get_buffer_raise(args[0].u_obj, &buf_info, MP_BUFFER_READ);
        data = (const char*)buf_info.buf;
    } else {
        switch(args[4].u_int) {
            case 1:
                data = go_top;
                buf_info.len = sizeof(go_top);
                break;
            case 2:
                data = go_bottom;
                buf_info.len = sizeof(go_bottom);
                break;
        }
    }

    int x = args[1].u_int;
    int y = args[2].u_int;
    int unset = args[3].u_int;
    int row = y/8;

    int offset = x + (row * 128);
    int shift = y % 8;
    _mark_dirty(row);
    if (y < 56) {
        _mark_dirty(row+1);
    }

    for (int i=0; i< buf_info.len; ++i) {
        int base_offset = offset + i;
        if (base_offset >= DISP_BUF_LEN) { break; }
        unsigned char base = data[i] << shift;
        switch(unset) {
            case 0: display_buf[base_offset] |= base; break;
            case 1: display_buf[base_offset] &= ~base; break;
        }
        if (shift > 0 && y < 56) {
            unsigned char extra = data[i] >> (8 - shift);
            switch(unset) {
                case 0: display_buf[base_offset + 128] |= extra; break;
                case 1: display_buf[base_offset + 128] &= ~extra; break;
            }
        }
    }

}
MP_DEFINE_CONST_FUN_OBJ_KW(display_blit_obj, 1, display_blit);

STATIC mp_obj_t display_clear(mp_obj_t _){
    for (int i=0; i<DISP_BUF_LEN; ++i) {
        display_buf[i] = 0;
    }
    display_buf_dirty = 0b11111111;
}
STATIC MP_DEFINE_CONST_FUN_OBJ_1(display_clear_obj, display_clear);



STATIC const mp_rom_map_elem_t display_locals_dict_table[] = {
    { MP_ROM_QSTR(MP_QSTR_repaint), MP_ROM_PTR(&display_repaint_obj) },
    { MP_ROM_QSTR(MP_QSTR_mark_dirty), MP_ROM_PTR(&display_mark_dirty_obj) },
    { MP_ROM_QSTR(MP_QSTR_blit), MP_ROM_PTR(&display_blit_obj) },
    { MP_ROM_QSTR(MP_QSTR_clear), MP_ROM_PTR(&display_clear_obj) },
};
STATIC MP_DEFINE_CONST_DICT(display_locals_dict, display_locals_dict_table);


const mp_obj_type_t mp_type_display = {
    { &mp_type_type },
    .name = MP_QSTR_display,
    //.print = array_print,
    //.make_new = array_make_new,
    //.getiter = array_iterator_new,
    .unary_op = display_unary_op,
    .binary_op = display_binary_op,
    .subscr = display_subscr,
    .buffer_p = { .get_buffer = display_get_buffer },
    .locals_dict = (mp_obj_dict_t*)&display_locals_dict,
};

typedef struct _microbit_i2c_obj_t {
    mp_obj_base_t base;
} microbit_display_buf_obj_t;


const microbit_display_buf_obj_t microbit_display_buf_obj = {
    {&mp_type_display},
};
